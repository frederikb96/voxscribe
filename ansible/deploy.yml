---
- name: Deploy Long STT daemon
  hosts: localhost
  connection: local
  gather_facts: true

  vars:
    repo_dir: "{{ playbook_dir | dirname }}"
    install_dir: "{{ ansible_facts['env']['HOME'] }}/.local/lib/long-stt"
    bin_dir: "{{ ansible_facts['env']['HOME'] }}/.local/bin"
    systemd_dir: "{{ ansible_facts['env']['HOME'] }}/.config/systemd/user"
    runtime_dir: "{{ ansible_facts['env']['XDG_RUNTIME_DIR'] }}"

  tasks:
    - name: Stop service if running
      ansible.builtin.systemd:
        name: long-stt
        state: stopped
        scope: user
      failed_when: false

    - name: Create installation directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ install_dir }}"
        - "{{ bin_dir }}"
        - "{{ systemd_dir }}"

    - name: Copy daemon source
      ansible.builtin.copy:
        src: "{{ repo_dir }}/src/daemon.py"
        dest: "{{ install_dir }}/daemon.py"
        mode: "0755"

    - name: Copy client source
      ansible.builtin.copy:
        src: "{{ repo_dir }}/src/client.py"
        dest: "{{ install_dir }}/client.py"
        mode: "0755"

    - name: Copy requirements
      ansible.builtin.copy:
        src: "{{ repo_dir }}/requirements.txt"
        dest: "{{ install_dir }}/requirements.txt"
        mode: "0644"

    - name: Copy config
      ansible.builtin.copy:
        src: "{{ repo_dir }}/config.yaml"
        dest: "{{ install_dir }}/config.yaml"
        mode: "0644"

    - name: Create Python venv
      ansible.builtin.command:
        cmd: python3 -m venv .venv
        chdir: "{{ install_dir }}"
        creates: "{{ install_dir }}/.venv/bin/python"

    - name: Install dependencies
      ansible.builtin.pip:
        requirements: "{{ install_dir }}/requirements.txt"
        virtualenv: "{{ install_dir }}/.venv"

    - name: Create client symlink
      ansible.builtin.file:
        src: "{{ install_dir }}/client.py"
        dest: "{{ bin_dir }}/long-stt-ctl"
        state: link
        force: true

    - name: Copy systemd service file
      ansible.builtin.copy:
        src: "{{ repo_dir }}/systemd/long-stt.service"
        dest: "{{ systemd_dir }}/long-stt.service"
        mode: "0644"

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true
        scope: user

    - name: Import Wayland environment variables
      ansible.builtin.command:
        cmd: systemctl --user import-environment WAYLAND_DISPLAY XDG_RUNTIME_DIR
      changed_when: true

    - name: Enable and start service
      ansible.builtin.systemd:
        name: long-stt
        enabled: true
        state: started
        scope: user

    - name: Wait for socket to be created
      ansible.builtin.wait_for:
        path: "{{ runtime_dir }}/long-stt.sock"
        timeout: 10

    - name: Verify service is running
      ansible.builtin.command:
        cmd: "{{ install_dir }}/.venv/bin/python {{ install_dir }}/client.py status"
      register: status_result
      changed_when: false

    - name: Show status
      ansible.builtin.debug:
        msg: "{{ status_result.stdout }}"
